sudo: required
language: python
services:
- docker

jobs:
  include:
  - stage: Check code quality
    before_install:
    - python -m pip install --upgrade pip
    install:
    - pip3 install flake8 black
    - pip3 install regex==2019.11.1
    script:
    - flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
    - flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
    - black --check .

  - stage: build docker image
    script:
    - sed -i "s/development/$TRAVIS_COMMIT/g" version.py
    - docker build -t tullingegymnasium/booking_app:latest .
    deploy:
      skip_cleanup: true
      provider: script
      script: echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin && docker push tullingegymnasium/booking_app:latest
      on:
        branch: master
    after_deploy:
    - rm -rf /home/travis/.docker/config.json

  - stage: deploy to ci
    env:
      - DOCKER_COMPOSE_VERSION=1.25.0
      - DOCKER_HOST=ssh://travis@tullingelabs.se
    before_install:
    - sudo rm /usr/local/bin/docker-compose
    - curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
    - chmod +x docker-compose
    - sudo mv docker-compose /usr/local/bin
    - echo "$PUB_HOST_KEY" >> $HOME/.ssh/known_hosts
    before_deploy:
    - openssl aes-256-cbc -K $encrypted_f534eed1d5e3_key -iv $encrypted_f534eed1d5e3_iv -in deploy_rsa.enc -out deploy_rsa -d
    - eval "$(ssh-agent -s)"
    - chmod 600 /tmp/deploy_rsa
    - ssh-add /tmp/deploy_rsa
    - docker stop booking_app_1
    - docker rm booking_app_1
    - docker rmi tullingegymnasium/booking_app
    deploy:
      provider: script
      script: docker-compose -f docker-compose.yml -f prod.yml up -d
      on:
        branch: master
